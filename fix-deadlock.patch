From 41c1662eee33df9358899cd36df970c08f4627cc Mon Sep 17 00:00:00 2001
From: Ray Strode <rstrode@redhat.com>
Date: Tue, 4 Oct 2011 18:00:11 -0400
Subject: [PATCH 1/3] window: ensure windows are realized before modifying them

We check if a window is flagged visible before modifying it,
but being flagged visible doesn't imply being realized.

This commit fixes console warnings in some obscure cases.
---
 src/gs-window-x11.c |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/gs-window-x11.c b/src/gs-window-x11.c
index d7add63..66149c4 100644
--- a/src/gs-window-x11.c
+++ b/src/gs-window-x11.c
@@ -293,7 +293,7 @@ gs_window_clear_to_background_pixmap (GSWindow *window)
 
         g_return_if_fail (GS_IS_WINDOW (window));
 
-        if (! GTK_WIDGET_VISIBLE (GTK_WIDGET (window))) {
+        if (! GTK_WIDGET_REALIZED (GTK_WIDGET (window)) || ! GTK_WIDGET_VISIBLE (GTK_WIDGET (window))) {
                 return;
         }
 
@@ -339,7 +339,7 @@ clear_widget (GtkWidget *widget)
         GtkStateType state;
         GtkStyle    *style;
 
-        if (! GTK_WIDGET_VISIBLE (widget)) {
+        if (! GTK_WIDGET_REALIZED (widget) || ! GTK_WIDGET_VISIBLE (widget)) {
                 return;
         }
 
-- 
1.7.1


From 170cae86a45d81304175df0fde6fb582c00f556d Mon Sep 17 00:00:00 2001
From: Ray Strode <rstrode@redhat.com>
Date: Tue, 4 Oct 2011 18:03:47 -0400
Subject: [PATCH 2/3] manager: fix deadlock

If the monitor topology changes during a fade out, we can
end up in a situation where a monitor gets realized while
under a server grab.  This causes deadlock because the
realization process invokes a helper that also needs a display
connection.

This commit ensures all windows are properly realized upfront,
so we don't end up in that sticky situation.
---
 src/gs-manager.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/src/gs-manager.c b/src/gs-manager.c
index f3f46f9..01efaf2 100644
--- a/src/gs-manager.c
+++ b/src/gs-manager.c
@@ -1548,6 +1548,8 @@ gs_manager_create_window_for_monitor (GSManager *manager,
 
         if (manager->priv->active && !manager->priv->fading) {
                 gtk_widget_show (window);
+        } else {
+                gtk_widget_realize (GTK_WIDGET (window));
         }
 }
 
-- 
1.7.1


From 228bbd1a6705eb5b12268da938f9bbc6e4f5096b Mon Sep 17 00:00:00 2001
From: Ray Strode <rstrode@redhat.com>
Date: Thu, 6 Oct 2011 11:00:22 -0400
Subject: [PATCH 3/3] window: place window when it's mapped

The code currently places the window when it's
realized, not when it's mapped.

Since we now realize the window when we create it,
not when we show it, that's wrong.

This commit places the window at map time.
---
 src/gs-window-x11.c |   17 +++++++++++++++--
 1 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/src/gs-window-x11.c b/src/gs-window-x11.c
index 66149c4..263b822 100644
--- a/src/gs-window-x11.c
+++ b/src/gs-window-x11.c
@@ -668,8 +668,6 @@ gs_window_real_realize (GtkWidget *widget)
 
         gs_window_override_user_time (GS_WINDOW (widget));
 
-        gs_window_move_resize_window (GS_WINDOW (widget), TRUE, TRUE);
-
         g_signal_connect (gtk_window_get_screen (GTK_WINDOW (widget)),
                           "size_changed",
                           G_CALLBACK (screen_size_changed),
@@ -924,6 +922,20 @@ gs_window_real_hide (GtkWidget *widget)
         }
 }
 
+static void
+gs_window_real_map (GtkWidget *widget)
+{
+        GSWindow *window;
+
+        window = GS_WINDOW (widget);
+
+        if (GTK_WIDGET_CLASS (gs_window_parent_class)->map) {
+                GTK_WIDGET_CLASS (gs_window_parent_class)->map (widget);
+        }
+
+        gs_window_move_resize_window (window, TRUE, TRUE);
+}
+
 void
 gs_window_destroy (GSWindow *window)
 {
@@ -2159,6 +2171,7 @@ gs_window_class_init (GSWindowClass *klass)
 
         widget_class->show                = gs_window_real_show;
         widget_class->hide                = gs_window_real_hide;
+        widget_class->map                 = gs_window_real_map;
         widget_class->realize             = gs_window_real_realize;
         widget_class->unrealize           = gs_window_real_unrealize;
         widget_class->key_press_event     = gs_window_real_key_press_event;
-- 
1.7.1

